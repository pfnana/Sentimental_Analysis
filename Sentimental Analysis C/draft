#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
 
/*
CHANGES:
at first your function call for tolowercase was wrong, you changed an uppercase letter somewhere
you apparently can;t do d irect comparison of possibly uppercase tokens from input with lowercase words from a dict,
so you had to introduce a buffer (lowerToken), copied the token into it, converted it to lowercase, and then compared
 
 
*/
 
#include "SAfunctions.h"
 
// Function prototypes
struct word* createVaderDict(const char *filename, int *number);
void deallocateWordArray(struct word *array, int length);
 
void deallocateScoreArray(struct score *array, int length);
void toLowerCase(char *str);
 
int main(int argc, char *argv[]) {
    if (argc == 2) {
        int number_of_words = 0;
        struct word* wordArray = createVaderDict(argv[1], &number_of_words);
        if (wordArray == NULL) {
            return 1;
        }
        deallocateWordArray(wordArray, number_of_words);
    } else if (argc == 3) {
        int number_of_words = 0, number_of_sentences = 0;
        struct word* wordArray = createVaderDict(argv[1], &number_of_words);
        if (wordArray == NULL) {
            return 1;
        }
 
        struct score* scoreArray = createScoreArray(wordArray, &number_of_sentences, number_of_words, argv[2]);
        if (!scoreArray) {
            deallocateWordArray(wordArray, number_of_words);
            return 1;
        }
 
        // Printing of sentences and scores
        printf("     String Sample\n");
        for (int i = 0; i < number_of_sentences; i++) {
            printf("%-100s %-7.6f\n", scoreArray[i].line, scoreArray[i].score);
        }
 
        // Memory deallocation
        deallocateScoreArray(scoreArray, number_of_sentences);
        deallocateWordArray(wordArray, number_of_words);
    } else {
        printf("Usage: %s <file path of vader_lexicon.txt> <file path of sentencefile.txt>\n", argv[0]);
        return 1;
    }
 
    return 0;
}
 
struct word* createVaderDict(const char *filename, int *number) {
    FILE *file = fopen(filename, "r");
    if (file == NULL) {
        printf("File wasn't opened.\n");
        return NULL;
    }
 
    struct word *wordArray = NULL;
    char *line = NULL;
    size_t linelen = 0;
    int lines_read = 0;
 
    while (getline(&line, &linelen, file) != -1) {
        wordArray = (struct word*)realloc(wordArray, (lines_read + 1) * sizeof(struct word));
        if (wordArray == NULL) {
            printf("Reallocation failed!\n");
            free(line);
            fclose(file);
            return NULL;
        }
        // Process the line to fill the current word struct
        // ...
        lines_read++;
    }
 
    fclose(file);
    free(line);
    *number = lines_read;
    return wordArray;
}
 
void deallocateWordArray(struct word *array, int length) {
    for (int i = 0; i < length; i++) {
        free(array[i].word);
    }
    free(array);
}
 
struct score* createScoreArray(struct word *wordArray, int *number, int arrayLength, const char *filename) {
    FILE *file = fopen(filename, "r");
    if (file == NULL) {
        printf("File wasn't opened.\n");
        return NULL;
    }
 
    struct score* scoreArray = NULL;
    char *line = NULL;
    size_t line_length = 0;
    int line_number = 0;
 
    while (getline(&line, &line_length, file) != -1) {
        char *sentence = strdup(line); // Copy the line for storage in scoreArray
        if (!sentence) {
            printf("Sentence allocation failed!\n");
            fclose(file);
            free(line);
            return NULL;
        }
 
        char *token = strtok(line, " ,.!?\n");
        char lowerToken[256]; // Assuming tokens won't exceed this length
        float sum = 0.0;
        int sentence_length = 0;
 
        while (token != NULL) {
            strncpy(lowerToken, token, sizeof(lowerToken) - 1);
            lowerToken[sizeof(lowerToken) - 1] = '\0'; // Ensure null termination
            toLowerCase(lowerToken);
 
            for (int i = 0; i < arrayLength; i++) {
                if (strcmp(lowerToken, wordArray[i].word) == 0) {
                    sum += wordArray[i].score;
                    break;
                }
            }
            token = strtok(NULL, " ,.!?\n");
            sentence_length++;
        }
 
        float avg = sentence_length > 0 ? sum / (float)sentence_length : 0.0;
        scoreArray = (struct score*)realloc(scoreArray, (line_number + 1) * sizeof(struct score));
        if (scoreArray == NULL) {
            printf("Reallocation of score array failed!\n");
            fclose(file);
            free(sentence);
            free(line);
            return NULL;
        }
 
        scoreArray[line_number].score = avg;
        scoreArray[line_number].line = sentence; // Already duplicated above
        line_number++;
    }
 
    fclose(file);
    free(line);
    *number = line_number;
    return scoreArray;
}
 
void toLowerCase(char *str) {
    if (!str) return;
    while (*str) {
        *str = tolower((unsigned char)*str);
        str++;
    }
}
 
void deallocateScoreArray(struct score *array, int length) {
    for (int i = 0; i < length; i++) {
        free(array[i].line);
    }
    free(array);
}
 